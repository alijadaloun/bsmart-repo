---
// Import full Tailwind - Astro will automatically split this per route
import '~/assets/styles/tailwind.css';

import { I18N } from 'astrowind:config';

import CommonMeta from '~/components/common/CommonMeta.astro';
import Favicons from '~/components/Favicons.astro';
import CustomStyles from '~/components/CustomStyles.astro';
import ApplyColorMode from '~/components/common/ApplyColorMode.astro';
import Metadata from '~/components/common/Metadata.astro';
import SiteVerification from '~/components/common/SiteVerification.astro';
import Analytics from '~/components/common/Analytics.astro';
import BasicScripts from '~/components/common/BasicScripts.astro';

// View Transitions disabled to reduce client bundle size
// Uncomment below to enable (adds ~200KB to client bundle)
// import { ClientRouter } from 'astro:transitions';

import type { MetaData as MetaDataType } from '~/types';

export interface Props {
  metadata?: MetaDataType;
}

const { metadata = {} } = Astro.props;
const { language, textDirection } = I18N;
---

<!doctype html>
<html lang={language} dir={textDirection} class="2xl:text-[20px]">
  <head>
    <CommonMeta />
    <Favicons />
    <CustomStyles />
    <ApplyColorMode />
    <Metadata {...metadata} />
    <SiteVerification />
    <Analytics />

    <!-- Critical CSS inlined for above-the-fold rendering -->
    <style is:global>
      /* Critical above-the-fold styles only */
      *, ::before, ::after {
        box-sizing: border-box;
        border-width: 0;
        border-style: solid;
        border-color: #e5e7eb;
      }
      html {
        line-height: 1.5;
        font-family: var(--aw-font-sans, ui-sans-serif, system-ui);
      }
      body {
        margin: 0;
        background-color: var(--aw-color-bg-page, #ffffff);
        color: var(--aw-color-text-default, #101010);
        font-family: var(--aw-font-sans, ui-sans-serif, system-ui);
      }
      #header {
        position: relative;
        top: 0;
        z-index: 40;
        width: 100%;
      }
      /* Add padding when header is fixed to prevent content overlap */
      #header.fixed {
        position: fixed;
      }
      body:has(#header.fixed) main {
        padding-top: 70px;
      }
      section[class*="relative"] {
        position: relative;
        min-height: 100vh;
      }
      h1, h2, h3 {
        font-weight: 700;
        line-height: 1.2;
        color: var(--aw-color-text-heading);
      }
      .btn-primary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        font-weight: 600;
        background-color: var(--aw-color-primary);
        color: white;
        padding: 0.625rem 1.5rem;
      }
    </style>

    <!-- View Transitions disabled to reduce client bundle size from 288KB to <80KB -->
    <!-- Uncomment below to enable smooth page transitions (adds ~200KB to client bundle) -->
    <!-- <ClientRouter fallback="swap" prefetch={false} /> -->
  </head>

  <body class="antialiased text-default bg-page tracking-tight">
    <slot />

    <BasicScripts />
    <script is:inline>
      // Initialize widget overlays to fade in on scroll
      (function() {
        function initWidgetOverlays() {
          const overlays = document.querySelectorAll('.widget-overlay:not([data-initialized])');
          
          overlays.forEach((overlay) => {
            overlay.setAttribute('data-initialized', 'true');
            const widgetSection = overlay.closest('.widget-section');
            
            if (!widgetSection) return;
            
            const observer = new IntersectionObserver(
              (entries) => {
                entries.forEach((entry) => {
                  if (entry.isIntersecting) {
                    overlay.style.opacity = '1';
                  } else {
                    overlay.style.opacity = '0';
                  }
                });
              },
              {
                threshold: 0.1,
                rootMargin: '0px'
              }
            );
            
            observer.observe(widgetSection);
          });
        }
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initWidgetOverlays);
        } else {
          initWidgetOverlays();
        }
        
        // Also handle dynamically added content
        const observer = new MutationObserver(initWidgetOverlays);
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
      })();
    </script>
  </body>
</html>
